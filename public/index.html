<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NextDev MP3 Player</title>
  <style>
    body { font-family:sans-serif; background:#111; color:#fff; padding:20px;}
    h1{text-align:center;}
    #controls,#equalizer{display:flex;justify-content:center;gap:10px;margin:10px 0;}
    #playlist{list-style:none;padding:0;max-height:300px;overflow-y:auto;}
    #playlist li{padding:10px;margin:5px 0;background:#333;cursor:grab;border-radius:4px;transition:background .2s;}
    #playlist li:hover{background:#444;}
    #playlist li.playing{background:#2a5a83;font-weight:bold;}
    input[type=range]{width:100px;}
    .track-info,.status{text-align:center;margin-top:10px;color:#aaa;}
    .progress-container{width:100%;height:6px;background:#333;border-radius:3px;margin:15px 0;cursor:pointer;}
    .progress-bar{height:100%;background:#4a8cff;border-radius:3px;width:0%;}
    .time-display{display:flex;justify-content:space-between;font-size:12px;color:#aaa;}
  </style>
</head>
<body>
<h1>üéß NextDev MP3 Player</h1>

<input type="file" id="fileInput" multiple accept=".mp3" />
<ul id="playlist"></ul>
<div class="track-info" id="trackInfo">No track selected</div>

<div class="progress-container" id="progressContainer">
  <div class="progress-bar" id="progressBar"></div>
</div>
<div class="time-display">
  <span id="currentTime">0:00</span>
  <span id="totalTime">0:00</span>
</div>

<div id="controls">
  <button id="prevBtn">‚èÆ Prev</button>
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="stopBtn">‚èπ Stop</button>
  <button id="nextBtn">‚è≠ Next</button>
  <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7" />
</div>

<div id="equalizer">
  <div><label>Bass</label><br><input type="range" id="bass" min="-40" max="40" value="0"/></div>
  <div><label>Mid</label><br><input type="range" id="mid" min="-40" max="40" value="0"/></div>
  <div><label>Treble</label><br><input type="range" id="treble" min="-40" max="40" value="0"/></div>
</div>

<label>‚è± Crossfade (seconds): <input type="number" id="crossfadeDuration" value="5" min="0" max="30"></label>
<div class="status" id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  const fileInput=document.getElementById("fileInput"),
        playlist=document.getElementById("playlist"),
        playBtn=document.getElementById("playBtn"),
        pauseBtn=document.getElementById("pauseBtn"),
        stopBtn=document.getElementById("stopBtn"),
        prevBtn=document.getElementById("prevBtn"),
        nextBtn=document.getElementById("nextBtn"),
        volumeSlider=document.getElementById("volume"),
        bassSlider=document.getElementById("bass"),
        midSlider=document.getElementById("mid"),
        trebleSlider=document.getElementById("treble"),
        crossfadeInput=document.getElementById("crossfadeDuration"),
        trackInfo=document.getElementById("trackInfo"),
        status=document.getElementById("status"),
        progressBar=document.getElementById("progressBar"),
        progressContainer=document.getElementById("progressContainer"),
        currTime=document.getElementById("currentTime"),
        totTime=document.getElementById("totalTime");

  let audioCtx,source,gainNode,bass,mid,treble;
  let audioBuffers=[],currentIndex=-1,isPlaying=false;
  let startTime=0,pausedAt=0,anim, isCross=false;

  fileInput.onchange=e=>{
    for(const file of [...e.target.files]){
      const li=document.createElement("li");
      li.textContent=file.name; li.file=file;
      playlist.appendChild(li);
    }
  };

  new Sortable(playlist,{animation:150});

  playlist.onclick=async e=>{
    if(e.target.tagName==="LI"){
      currentIndex=[...playlist.children].indexOf(e.target);
      await playSelected();
    }
  };

  progressContainer.onclick=e=>{
    if(!source?.buffer) return;
    const rect=progressContainer.getBoundingClientRect(),
          pct=(e.clientX-rect.left)/rect.width;
    const seek=pct*source.buffer.duration;
    source.stop();source.disconnect();
    pausedAt=seek;
    startSource();
  };

  function setup(){
    if(audioCtx) return;
    audioCtx=new (window.AudioContext||webkitAudioContext)();
    gainNode=audioCtx.createGain();

    bass=audioCtx.createBiquadFilter(); bass.type="lowshelf"; bass.frequency.value=200;
    mid =audioCtx.createBiquadFilter(); mid.type="peaking"; mid.frequency.value=1000;
    treble=audioCtx.createBiquadFilter(); treble.type="highshelf"; treble.frequency.value=3000;

    bass.connect(mid); mid.connect(treble); treble.connect(gainNode); gainNode.connect(audioCtx.destination);
    gainNode.gain.value=volumeSlider.value;
  }

  async function playSelected(){
    stopAudio(); isPlaying=true;
    setup();
    const li=playlist.children[currentIndex];
    if(!audioBuffers[currentIndex]){
      const ab=await li.file.arrayBuffer();
      audioBuffers[currentIndex]=await audioCtx.decodeAudioData(ab);
    }
    pausedAt=0;
    startSource();
  }

  function startSource(){
    setup();
    const li=playlist.children[currentIndex];
    source=audioCtx.createBufferSource();
    source.buffer=audioBuffers[currentIndex];
    source.connect(bass);
    startTime=audioCtx.currentTime-pausedAt;
    source.start(0,pausedAt);

    trackInfo.textContent="Now Playing: "+li.file.name;
    [...playlist.children].forEach(l=>l.classList.remove("playing"));
    li.classList.add("playing");

    if(anim)cancelAnimationFrame(anim);
    updateProgress();

    source.onended=()=>{ if(isPlaying) playNext(); }; // fallback only
  }

  function stopAudio(){
    if(source){source.stop();source.disconnect();}
    source=null;
    isPlaying=false; pausedAt=0; isCross=false;
    if(anim)cancelAnimationFrame(anim);
    progressBar.style.width="0%";
    currTime.textContent="0:00";
  }

  async function playNext(){
    if(!playlist.children.length) return;
    currentIndex=(currentIndex+1)%playlist.children.length;
    await playSelected();
  }

  async function crossfadeTo(nextIndex, duration){
    isCross=true;
    status.textContent="Crossfading...";

    const old=source;
    const li=playlist.children[nextIndex];

    // preload
    if(!audioBuffers[nextIndex]){
      const ab=await li.file.arrayBuffer();
      audioBuffers[nextIndex]=await audioCtx.decodeAudioData(ab);
    }
    const newS=audioCtx.createBufferSource();
    newS.buffer=audioBuffers[nextIndex];
    newS.connect(bass);

    const oldGain=audioCtx.createGain(), newGain=audioCtx.createGain();
    old.disconnect(); old.connect(oldGain); oldGain.connect(bass);
    newS.connect(newGain); newGain.connect(bass);

    const t=audioCtx.currentTime;
    oldGain.gain.setValueAtTime(1,t);
    oldGain.gain.linearRampToValueAtTime(0,t+duration);
    newGain.gain.setValueAtTime(0,t);
    newGain.gain.linearRampToValueAtTime(1,t+duration);

    newS.start();
    old.stop(t+duration);

    // switch references
    source=newS;
    currentIndex=nextIndex;
    startTime=audioCtx.currentTime; pausedAt=0;

    trackInfo.textContent="Now Playing: "+li.file.name;
    [...playlist.children].forEach(i=>i.classList.remove("playing"));
    li.classList.add("playing");

    newS.onended=()=>{ if(isPlaying) playNext(); };
    status.textContent="";
    isCross=false;
  }

  function updateProgress(){
    if(!source?.buffer) return;
    const current=pausedAt+(audioCtx.currentTime-startTime),
          dur=source.buffer.duration;
    progressBar.style.width=`${(current/dur)*100}%`;
    currTime.textContent=fmt(current);
    totTime.textContent=fmt(dur);

    const cDur=parseFloat(crossfadeInput.value||"0");
    if(cDur>0 && dur-current<=cDur && !isCross && playlist.children.length>1 && isPlaying){
      const nextIndex=(currentIndex+1)%playlist.children.length;
      crossfadeTo(nextIndex,cDur);
    }
    if(isPlaying) anim=requestAnimationFrame(updateProgress);
  }

  function fmt(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${sec<10?"0":""}${sec}`;}

  playBtn.onclick=async()=>{
    if(audioCtx?.state==="suspended")await audioCtx.resume();
    if(!isPlaying&&currentIndex>=0) await playSelected();
    else if(!isPlaying&&currentIndex===-1&&playlist.children.length){currentIndex=0;await playSelected();}
  };

  pauseBtn.onclick=()=>{
    if(source){pausedAt+=audioCtx.currentTime-startTime; source.stop(); source.disconnect(); isPlaying=false; if(anim)cancelAnimationFrame(anim);}
  };

  stopBtn.onclick=()=>{
    stopAudio();
    trackInfo.textContent="Stopped";
    [...playlist.children].forEach(l=>l.classList.remove("playing"));
  };

  prevBtn.onclick=async()=>{if(!playlist.children.length)return; currentIndex=(currentIndex-1+playlist.children.length)%playlist.children.length; await playSelected();}
  nextBtn.onclick=()=>playNext();

  volumeSlider.oninput=()=>gainNode?.gain.setValueAtTime(volumeSlider.value,audioCtx.currentTime);
  bassSlider.oninput=()=>{if(bass)bass.gain.value=bassSlider.value;}
  midSlider.oninput =()=>{if(mid)mid.gain.value =midSlider.value;}
  trebleSlider.oninput=()=>{if(treble)treble.gain.value=trebleSlider.value;}
</script>
</body>
</html>
