<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üé∂ NextDev MP3 Player</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#0d0d0d; color:#fff; display:flex; flex-direction:column; align-items:center; padding:20px;}
h1 { text-align:center; color:#4a8cff; }
#playlist { list-style:none; padding:0; max-height:250px; overflow-y:auto; width:300px; }
#playlist li { padding:10px; margin:5px 0; background:#222; cursor:pointer; border-radius:8px; display:flex; align-items:center; gap:10px; transition:0.3s; }
#playlist li.playing { background:#4a8cff; font-weight:bold; color:#fff; }
#playlist li:hover { background:#333; }

#controls { display:flex; gap:10px; margin:15px; justify-content:center; flex-wrap:wrap; }
button { padding:8px 12px; border:none; border-radius:6px; background:#222; color:#fff; cursor:pointer; transition:0.2s; }
button:hover { background:#4a8cff; color:#fff; }

#shuffleBtn.active, #repeatBtn.active { background:#4aff88; color:#000; }

#progressContainer { width:300px; height:8px; background:#333; border-radius:4px; margin:10px 0; cursor:pointer; }
.progress-bar { height:100%; background: linear-gradient(90deg,#4a8cff,#4aff88); width:0%; border-radius:4px; transition:0.1s; }

.track-info { margin:10px 0; font-style:italic; color:#aaa; text-align:center; }

#cassette { width:120px; height:60px; background:#222; border-radius:6px; display:flex; justify-content:space-around; align-items:center; margin:15px 0; position:relative; }
.reel { width:20px; height:20px; border:3px solid #4a8cff; border-radius:50%; animation: spin 2s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

input[type="range"] { width:100px; }
.slider-group { text-align:center; margin:5px; }
.status { text-align:center; height:20px; margin-top:10px; color:#4a8cff; }

#equalizer { display:flex; justify-content:center; gap:10px; margin:10px 0; }
</style>
</head>
<body>
<h1>üéß NextDev MP3 Player</h1>

<input type="file" id="fileInput" multiple accept=".mp3" />
<ul id="playlist"></ul>

<div id="cassette"><div class="reel"></div><div class="reel"></div></div>

<div class="track-info" id="trackInfo">No track selected</div>

<div id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
<div class="time-display" style="width:300px; display:flex; justify-content:space-between;">
  <span id="currentTime">0:00</span>
  <span id="totalTime">0:00</span>
</div>

<div id="controls">
  <button id="prevBtn">‚èÆÔ∏è</button>
  <button id="playBtn">‚ñ∂Ô∏è</button>
  <button id="pauseBtn">‚è∏Ô∏è</button>
  <button id="stopBtn">‚èπÔ∏è</button>
  <button id="nextBtn">‚è≠Ô∏è</button>
  <button id="shuffleBtn">üîÄ</button>
  <button id="repeatBtn">üîÅ</button>
  <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7" />
</div>

<div id="equalizer">
  <div class="slider-group"><label>Bass</label><br><input type="range" id="bass" min="-40" max="40" value="0" /></div>
  <div class="slider-group"><label>Mid</label><br><input type="range" id="mid" min="-40" max="40" value="0" /></div>
  <div class="slider-group"><label>Treble</label><br><input type="range" id="treble" min="-40" max="40" value="0" /></div>
</div>

<label>‚è±Ô∏è Crossfade Duration (sec):
  <input type="number" id="crossfadeDuration" value="5" min="0" max="30" />
</label>

<div class="status" id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const fileInput = document.getElementById('fileInput');
const playlist = document.getElementById('playlist');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const volumeSlider = document.getElementById('volume');
const bassSlider = document.getElementById('bass');
const midSlider = document.getElementById('mid');
const trebleSlider = document.getElementById('treble');
const crossfadeInput = document.getElementById('crossfadeDuration');
const trackInfo = document.getElementById('trackInfo');
const progressBar = document.getElementById('progressBar');
const progressContainer = document.getElementById('progressContainer');
const status = document.getElementById('status');

let audioCtx, gainNode, bass, mid, treble;
let audioBuffers=[], currentIndex=-1, isPlaying=false;
let currentSource=null, nextSource=null;
let startTime=0, pausedAt=0, animationFrame=null;
let isCrossfading=false;
let shuffle=false, repeat=false;

// Playlist
fileInput.addEventListener('change',(e)=>{
  for(const file of Array.from(e.target.files)){
    const li=document.createElement('li'); li.textContent=file.name; li.file=file;
    playlist.appendChild(li);
  }
});
new Sortable(playlist,{animation:150});

// Shuffle & Repeat buttons
shuffleBtn.addEventListener('click'=>{ shuffle=!shuffle; shuffleBtn.classList.toggle('active'); });
repeatBtn.addEventListener('click'=>{ repeat=!repeat; repeatBtn.classList.toggle('active'); });

function setupAudioCtx(){
  if(audioCtx && audioCtx.state!=='closed') return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  gainNode=audioCtx.createGain(); gainNode.gain.value=volumeSlider.value;
  bass=audioCtx.createBiquadFilter(); bass.type='lowshelf'; bass.frequency.value=200;
  mid=audioCtx.createBiquadFilter(); mid.type='peaking'; mid.frequency.value=1000;
  treble=audioCtx.createBiquadFilter(); treble.type='highshelf'; treble.frequency.value=3000;
  bass.connect(mid); mid.connect(treble); treble.connect(gainNode); gainNode.connect(audioCtx.destination);
}

async function playTrack(index,resume=false){
  if(playlist.children.length===0) return;
  stopAllSources();
  setupAudioCtx();
  currentIndex=index;

  const li=playlist.children[index];
  if(!audioBuffers[index]){
    const arrayBuffer=await li.file.arrayBuffer();
    audioBuffers[index]=await audioCtx.decodeAudioData(arrayBuffer);
  }

  currentSource=audioCtx.createBufferSource();
  currentSource.buffer=audioBuffers[index];
  currentSource.connect(bass);
  startTime=audioCtx.currentTime-(resume?pausedAt:0);
  currentSource.start(0,resume?pausedAt:0);
  isPlaying=true; pausedAt=0;
  updateUI();

  currentSource.onended=()=>{ if(!isCrossfading) nextTrack(); };
  requestAnimationFrame(updateProgress);
}

function nextTrack(){
  let nextIndex;
  if(shuffle){
    do{ nextIndex=Math.floor(Math.random()*playlist.children.length);}while(nextIndex===currentIndex && playlist.children.length>1);
  }else{
    nextIndex=(currentIndex+1)%playlist.children.length;
    if(nextIndex===0 && !repeat) { isPlaying=false; return; }
  }
  crossfadeTo(nextIndex);
}

async function crossfadeTo(nextIndex){
  if(playlist.children.length<=1) return;
  isCrossfading=true; status.textContent='Crossfading...';

  const li=playlist.children[nextIndex];
  if(!audioBuffers[nextIndex]){
    const arrayBuffer=await li.file.arrayBuffer();
    audioBuffers[nextIndex]=await audioCtx.decodeAudioData(arrayBuffer);
  }

  nextSource=audioCtx.createBufferSource();
  nextSource.buffer=audioBuffers[nextIndex];

  const oldGain=audioCtx.createGain();
  const newGain=audioCtx.createGain();

  currentSource.disconnect(); currentSource.connect(oldGain); oldGain.connect(bass);
  nextSource.connect(newGain); newGain.connect(bass);

  const duration=parseFloat(crossfadeInput.value)||0;
  const now=audioCtx.currentTime;
  oldGain.gain.setValueAtTime(1,now); oldGain.gain.linearRampToValueAtTime(0,now+duration);
  newGain.gain.setValueAtTime(0,now); newGain.gain.linearRampToValueAtTime(1,now+duration);

  startTime=audioCtx.currentTime; pausedAt=0; currentIndex=nextIndex; updateUI();
  nextSource.onended=()=>{ if(!isCrossfading) nextTrack(); };
  nextSource.start();

  setTimeout(()=>{ stopSource(currentSource); currentSource=nextSource; nextSource=null; isCrossfading=false; status.textContent=''; }, duration*1000);
}

function stopSource(source){ if(!source) return; try{ source.stop(); source.disconnect();}catch(e){} }
function stopAllSources(){ stopSource(currentSource); stopSource(nextSource); currentSource=null; nextSource=null; isPlaying=false; isCrossfading=false; pausedAt=0; progressBar.style.width='0%'; status.textContent=''; }

function updateProgress(){
  if(!currentSource || !currentSource.buffer) return;
  const currentTime=pausedAt+(audioCtx.currentTime-startTime);
  const duration=currentSource.buffer.duration;
  const percent=(currentTime/duration)*100;
  progressBar.style.width=percent+'%';
  document.getElementById('currentTime').textContent=formatTime(currentTime);
  document.getElementById('totalTime').textContent=formatTime(duration);
  if(isPlaying && !isCrossfading && duration-currentTime<=parseFloat(crossfadeInput.value||0) && playlist.children.length>1){
    nextTrack();
  }
  if(isPlaying) requestAnimationFrame(updateProgress);
}

function updateUI(){
  [...playlist.children].forEach(i=>i.classList.remove('playing'));
  playlist.children[currentIndex].classList.add('playing');
  trackInfo.textContent='Now Playing: '+playlist.children[currentIndex].file.name;
}

function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60); return `${m}:${s<10?'0':''}${s}`; }

playBtn.addEventListener('click',async()=>{ if(audioCtx && audioCtx.state==='suspended') await audioCtx.resume(); if(!isPlaying && currentIndex>=0) playTrack(currentIndex); else if(!isPlaying && currentIndex===-1 && playlist.children.length>0) playTrack(0); });
pauseBtn.addEventListener('click',()=>{ if(currentSource){ pausedAt+=audioCtx.currentTime-startTime; stopSource(currentSource); currentSource=null; isPlaying=false; } });
stopBtn.addEventListener('click',()=>{ stopAllSources(); trackInfo.textContent='Playback stopped'; });
prevBtn.addEventListener('click',()=>{ let prev=(currentIndex-1+playlist.children.length)%playlist.children.length; crossfadeTo(prev); });
nextBtn.addEventListener('click',()=>{ nextTrack(); });

volumeSlider.addEventListener('input',()=>{ if(gainNode) gainNode.gain.setValueAtTime(volumeSlider.value,audioCtx.currentTime); });
bassSlider.addEventListener('input',()=>{ if(bass) bass.gain.value=bassSlider.value; });
midSlider.addEventListener('input',()=>{ if(mid) mid.gain.value=midSlider.value; });
trebleSlider.addEventListener('input',()=>{ if(treble) treble.gain.value=trebleSlider.value; });
</script>
</body>
</html>
