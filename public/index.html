<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NextDev MP3 Player</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }
  h1 { margin-bottom: 10px; }
  #fileInput { margin-bottom: 10px; }
  #playlist { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
  #playlist li {
    background: #222;
    margin: 5px;
    padding: 8px;
    border-radius: 4px;
    cursor: grab;
    transition: background 0.2s;
  }
  #playlist li:hover { background: #444; }
  #playlist li.playing { background: #2a5a83; font-weight: bold; }
  #controls { margin: 10px 0; display: flex; justify-content: center; gap: 8px; }
  button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
  input[type=range] { vertical-align: middle; }
  #cassette {
    margin: 20px auto;
    width: 180px; height: 80px;
    background: #222;
    border: 4px solid #555;
    border-radius: 6px;
    position: relative;
    overflow: hidden;
  }
  .reel {
    width: 30px; height: 30px;
    border: 4px solid #999;
    border-radius: 50%;
    position: absolute;
    top: 15px;
    animation: spin 0s linear infinite;
  }
  .reel.left { left: 20px; }
  .reel.right { right: 20px; }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  .slider-group { display: inline-block; margin: 0 8px; }
  .track-info { margin-top: 10px; font-style: italic; color: #aaa; }
  .progress-container {
    width: 80%; height: 8px; background: #333;
    margin: 10px auto; border-radius: 4px; cursor: pointer;
    position: relative;
  }
  .progress-bar {
    width: 0%; height: 100%; background: #4a8cff; border-radius: 4px;
  }
  #status { margin-top: 5px; font-size: 14px; color: #4a8cff; }
</style>
</head>
<body>

<h1>üéß NextDev MP3 Player</h1>
<input type="file" id="fileInput" multiple accept=".mp3"><br>
<ul id="playlist"></ul>

<div id="cassette">
  <div class="reel left"></div>
  <div class="reel right"></div>
</div>

<div class="track-info" id="trackInfo">No track selected</div>

<div class="progress-container" id="progressContainer">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div class="time-display">
  <span id="currentTime">0:00</span>
  <span id="totalTime">0:00</span>
</div>

<div id="controls">
  <button id="prevBtn">‚èÆÔ∏è</button>
  <button id="playBtn">‚ñ∂Ô∏è</button>
  <button id="pauseBtn">‚è∏Ô∏è</button>
  <button id="stopBtn">‚èπÔ∏è</button>
  <button id="nextBtn">‚è≠Ô∏è</button>
  <button id="shuffleBtn">üîÄ</button>
  <button id="repeatBtn">üîÅ</button>
</div>

<div id="equalizer">
  <div class="slider-group"><label>Bass</label><br><input type="range" id="bass" min="-40" max="40" value="0"></div>
  <div class="slider-group"><label>Mid</label><br><input type="range" id="mid" min="-40" max="40" value="0"></div>
  <div class="slider-group"><label>Treble</label><br><input type="range" id="treble" min="-40" max="40" value="0"></div>
</div>

<label>‚è±Ô∏è Crossfade Duration (sec):
  <input type="number" id="crossfadeDuration" value="5" min="0" max="30">
</label>

<div class="status" id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const fileInput = document.getElementById('fileInput');
const playlist = document.getElementById('playlist');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const volumeSlider = document.getElementById('volume');
const bassSlider = document.getElementById('bass');
const midSlider = document.getElementById('mid');
const trebleSlider = document.getElementById('treble');
const crossfadeInput = document.getElementById('crossfadeDuration');
const trackInfo = document.getElementById('trackInfo');
const progressBar = document.getElementById('progressBar');
const progressContainer = document.getElementById('progressContainer');
const currentTimeDisplay = document.getElementById('currentTime');
const totalTimeDisplay = document.getElementById('totalTime');
const status = document.getElementById('status');
const leftReel = document.querySelector('.reel.left');
const rightReel = document.querySelector('.reel.right');

let audioCtx, gainNode, bass, mid, treble;
let audioBuffers = [];
let currentIndex = -1, isPlaying = false, animationFrame;
let currentSource = null, nextSource = null;
let startTime = 0, pausedAt = 0;
let shuffle = false, repeat = false;

fileInput.addEventListener('change', (e) => {
  for (const file of e.target.files) {
    const li = document.createElement('li');
    li.textContent = file.name;
    li.file = file;
    playlist.appendChild(li);
  }
});

new Sortable(playlist, {animation: 150});

playlist.addEventListener('click', async e => {
  if(e.target.tagName === 'LI'){
    currentIndex = [...playlist.children].indexOf(e.target);
    await playTrack(currentIndex);
  }
});

function setupAudioCtx(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  bass = audioCtx.createBiquadFilter(); bass.type='lowshelf'; bass.frequency.value=200;
  mid = audioCtx.createBiquadFilter(); mid.type='peaking'; mid.frequency.value=1000;
  treble = audioCtx.createBiquadFilter(); treble.type='highshelf'; treble.frequency.value=3000;
  bass.connect(mid); mid.connect(treble); treble.connect(gainNode); gainNode.connect(audioCtx.destination);
}

async function loadBuffer(index){
  if(!audioBuffers[index]){
    const li = playlist.children[index];
    const arrayBuffer = await li.file.arrayBuffer();
    audioBuffers[index] = await audioCtx.decodeAudioData(arrayBuffer);
  }
  return audioBuffers[index];
}

async function playTrack(index, crossfade=0){
  setupAudioCtx();
  if(currentSource){ 
    if(crossfade>0){ await crossfadeTracks(currentSource, index, crossfade); return; }
    stopCurrent();
  }

  const buffer = await loadBuffer(index);
  currentSource = audioCtx.createBufferSource();
  currentSource.buffer = buffer;
  currentSource.connect(bass);
  currentSource.start(0, pausedAt);
  startTime = audioCtx.currentTime - pausedAt;
  isPlaying = true;
  pausedAt = 0;

  updateUI(index);
  rotateReels(true);

  currentSource.onended = () => {
    if(!isPlaying) return;
    playNext();
  };

  updateProgress();
}

function stopCurrent(){
  if(currentSource){ currentSource.stop(); currentSource.disconnect(); currentSource=null; }
  if(nextSource){ nextSource.stop(); nextSource.disconnect(); nextSource=null; }
  pausedAt = 0; isPlaying=false; rotateReels(false);
}

function updateUI(index){
  const li = playlist.children[index];
  trackInfo.textContent = `Now Playing: ${li.file.name}`;
  [...playlist.children].forEach(li=>li.classList.remove('playing'));
  li.classList.add('playing');
}

function updateProgress(){
  if(!currentSource||!currentSource.buffer) return;
  const duration = currentSource.buffer.duration;
  const currentTime = pausedAt + (audioCtx.currentTime-startTime);
  progressBar.style.width = (currentTime/duration*100)+'%';
  currentTimeDisplay.textContent = formatTime(currentTime);
  totalTimeDisplay.textContent = formatTime(duration);

  const crossfade = parseFloat(crossfadeInput.value||'0');
  if(crossfade>0 && duration-currentTime<=crossfade && playlist.children.length>1){
    if(!nextSource) playNext(crossfade);
  }

  if(isPlaying) animationFrame=requestAnimationFrame(updateProgress);
}

function formatTime(s){ const m=Math.floor(s/60); const sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }

function playNext(crossfade=0){
  if(shuffle){
    currentIndex=Math.floor(Math.random()*playlist.children.length);
  } else{
    currentIndex=(currentIndex+1)%playlist.children.length;
    if(currentIndex===0 && !repeat) { stopCurrent(); return; }
  }
  playTrack(currentIndex,crossfade);
}

function playPrev(){ 
  currentIndex=(currentIndex-1+playlist.children.length)%playlist.children.length;
  playTrack(currentIndex);
}

async function crossfadeTracks(oldSource,newIndex,duration){
  const buffer = await loadBuffer(newIndex);
  nextSource = audioCtx.createBufferSource();
  nextSource.buffer = buffer;
  const newGain = audioCtx.createGain();
  const oldGain = audioCtx.createGain();

  oldSource.disconnect(); oldSource.connect(oldGain); oldGain.connect(bass);
  nextSource.connect(newGain); newGain.connect(bass);

  const now = audioCtx.currentTime;
  oldGain.gain.setValueAtTime(1, now);
  oldGain.gain.linearRampToValueAtTime(0, now+duration);
  newGain.gain.setValueAtTime(0, now);
  newGain.gain.linearRampToValueAtTime(1, now+duration);

  nextSource.start();
  currentSource = nextSource;
  nextSource=null;
}

function rotateReels(on){
  if(on){ leftReel.style.animation='spin 1s linear infinite'; rightReel.style.animation='spin 1s linear infinite'; }
  else{ leftReel.style.animation=''; rightReel.style.animation=''; }
}

// Controls
playBtn.addEventListener('click',()=>{ if(!isPlaying) playTrack(currentIndex>=0?currentIndex:0); });
pauseBtn.addEventListener('click',()=>{ if(currentSource){ pausedAt+=audioCtx.currentTime-startTime; currentSource.stop(); currentSource.disconnect(); currentSource=null; isPlaying=false; rotateReels(false); }});
stopBtn.addEventListener('click',()=>{ stopCurrent(); trackInfo.textContent='Stopped'; progressBar.style.width='0%'; currentTimeDisplay.textContent='0:00'; totalTimeDisplay.textContent='0:00'; });
nextBtn.addEventListener('click',()=>{ playNext(); });
prevBtn.addEventListener('click',()=>{ playPrev(); });
shuffleBtn.addEventListener('click',()=>{ shuffle=!shuffle; shuffleBtn.style.background=shuffle?'#4a8cff':'#555'; });
repeatBtn.addEventListener('click',()=>{ repeat=!repeat; repeatBtn.style.background=repeat?'#4a8cff':'#555'; });

// Equalizer
bassSlider.addEventListener('input',()=>{ if(bass) bass.gain.value=bassSlider.value; });
midSlider.addEventListener('input',()=>{ if(mid) mid.gain.value=midSlider.value; });
trebleSlider.addEventListener('input',()=>{ if(treble) treble.gain.value=trebleSlider.value; });

// Click progress
progressContainer.addEventListener('click', e=>{
  if(!currentSource||!currentSource.buffer) return;
  const rect=progressContainer.getBoundingClientRect();
  const pos=(e.clientX-rect.left)/rect.width;
  pausedAt=pos*currentSource.buffer.duration;
  playTrack(currentIndex);
});
</script>
</body>
</html>
